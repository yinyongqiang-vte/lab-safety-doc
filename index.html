<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©æ´¥åŒ»ç§‘å¤§å­¦åŸºç¡€åŒ»å­¦é™¢å®éªŒå®¤å®‰å…¨æ£€æŸ¥</title>
    <style>
        :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 300px; }
        
        /* åŸºç¡€æ ·å¼ */
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 16px 0; color: var(--primary); text-align: center; font-size: 18px; line-height: 1.4; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 14px; color: #8e8e93; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #d1d1d6; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; font-family: inherit; }
        textarea { height: 70px; resize: none; margin-top: 5px; background: #fff; }
        
        .cat-title { font-weight: bold; font-size: 16px; margin: 20px 0 10px 4px; border-left: 4px solid var(--primary); padding-left: 8px; color:#333; }
        .item-box { padding: 15px 10px; border-bottom: 1px solid #f2f2f7; background: #fff; margin-bottom: 5px; border-radius: 8px; }
        .item-header { font-weight: 600; font-size: 15px; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .item-desc { font-size: 13px; color: #636366; margin-bottom: 12px; line-height: 1.4; }
        
        .btn-group { display: flex; gap: 8px; }
        .btn { flex: 1; padding: 12px; border: 1.5px solid #d1d1d6; border-radius: 10px; background: white; font-weight: 600; text-align: center; }
        .btn.active-y { background: var(--success); color: white; border-color: var(--success); }
        .btn.active-n { background: var(--danger); color: white; border-color: var(--danger); }
        
        .hazard-area { margin-top: 12px; display: none; background: #f9f9f9; padding: 12px; border-radius: 8px; border: 1px dashed #ccc; }
        .camera-btn { background: #5856d6; color: white; padding: 8px 12px; border-radius: 6px; font-size: 13px; display: inline-block; cursor: pointer; margin-bottom: 10px; }
        .thumb-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .thumb-wrap { position: relative; width: 70px; height: 70px; }
        .thumb-img { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .del-x { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; text-align: center; line-height: 20px; border: none; }

        .sticky-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px; border-top: 1px solid #ddd; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .main-btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .sub-btn { background: #e5e5ea; border: none; padding: 10px; border-radius: 10px; font-size: 12px; font-weight: 600; color: #333; }
        
        #preview-layer { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; overflow-y:auto; padding:15px; box-sizing:border-box; }
        .report-card { border: 2px solid #333; padding: 15px; margin-bottom: 25px; border-radius: 12px; background: #fff; }
        .lab-tag { background: #333; color: white; padding: 8px; border-radius: 4px; margin: -15px -15px 15px -15px; font-weight: bold; }
        .hazard-text { background: #fff1f0; border-left: 4px solid var(--danger); padding: 8px; margin: 10px 0; font-size: 13px; }
    </style>
</head>
<body>

    <div id="check-ui">
        <div class="card">
            <h2>å¤©æ´¥åŒ»ç§‘å¤§å­¦åŸºç¡€åŒ»å­¦é™¢<br>å®éªŒå®¤å®‰å…¨æ£€æŸ¥</h2>
            <input type="text" id="labName" placeholder="å®éªŒå®¤åç§°/æˆ¿é—´å·" oninput="saveDraft()">
            <input type="text" id="inspector" placeholder="æ£€æŸ¥äººå‘˜å§“å" oninput="saveDraft()">
        </div>

        <div id="item-list"></div>

        <div class="sticky-bar">
            <button class="main-btn" onclick="saveToDB()">âœ… ä¿å­˜å½“å‰å®éªŒå®¤è®°å½•</button>
            <div class="action-grid">
                <button class="sub-btn" onclick="openPreview()">ğŸ“¸ é¢„è§ˆæŠ¥å‘Š</button>
                <button class="sub-btn" onclick="shareCSV()">ğŸ“Š å¯¼å‡º CSV è¡¨æ ¼</button>
                <button class="sub-btn" onclick="exportJSON()">ğŸ’¾ å¤‡ä»½ JSON (å¯æ¢å¤)</button>
                <button class="sub-btn" onclick="exportWord()">ğŸ“„ å…±äº«å¯¼å‡º Word (å­˜æ¡£)</button>
                <button class="sub-btn" onclick="triggerImport()">ğŸ“‚ æ¢å¤å¤‡ä»½æ•°æ®</button>
                <button class="sub-btn" style="color:red;" onclick="resetAll()">ğŸ—‘ï¸ å½»åº•é‡ç½®æ¸…ç©º</button>
            </div>
            <div id="status" style="font-size:11px; color:#999; margin-top:8px; text-align:center;">æœ¬åœ°å·²å­˜ 0 æ¡è®°å½•</div>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importBackup(this)">
        </div>
    </div>

    <div id="preview-layer">
        <div id="preview-content"></div>
        <div class="sticky-bar">
            <button class="sub-btn" style="width:100%; padding:15px;" onclick="closePreview()">è¿”å›ä¿®æ”¹</button>
        </div>
    </div>

    <script>
        // æ£€æŸ¥é¡¹ç›®å®šä¹‰ (æƒé‡æ€»å’Œçº¦ä¸º100åˆ†)
        const inspectionItems = [
            { cat: "ç»„ç»‡ç®¡ç†ä¸åŸºç¡€ç¯å¢ƒ", items: [
                { id: 0, name: "è´£ä»»ä½“ç³»", desc: "å®éªŒå®¤ä¿¡æ¯æ˜¯å¦æŒ‚åœ¨é—¨å£é†’ç›®ä½ç½®ï¼Ÿ", score: 4 },
                { id: 1, name: "è§„ç« åˆ¶åº¦", desc: "å®éªŒå®¤å†…æ˜¯å¦å¼ è´´ç›¸å…³çš„å®‰å…¨æ“ä½œè§„ç¨‹ï¼ˆå¦‚SOPï¼‰ï¼Ÿ", score: 4 },
                { id: 2, name: "ç¯å¢ƒå«ç”Ÿ", desc: "å®éªŒå®¤èµ°å»ŠåŠå‡ºå£æ˜¯å¦ä¿æŒé€šç•…ï¼Ÿæ¡Œé¢ï¼Œåœ°é¢æ˜¯å¦æ•´æ´ï¼Ÿ", score: 4 },
                { id: 3, name: "é¥®é£Ÿç¦ä»¤", desc: "å®éªŒå®¤éç”Ÿæ´»åŒºå†…ä¸¥ç¦å­˜æ”¾é£Ÿç‰©ã€é¥®æ°´ï¼Œä¸¥ç¦åƒä¸œè¥¿ï¼Ÿ", score: 3 }
            ]},
            { cat: "ç”Ÿç‰©å®‰å…¨", items: [
                { id: 4, name: "æ ·æœ¬å­˜æ”¾", desc: "å†°ç®±å†…çš„ç”Ÿç‰©æ ·æœ¬ï¼ˆç»†èƒã€ç»„ç»‡ã€ç—…æ¯’æ ªï¼‰æ˜¯å¦æœ‰æ¸…æ™°æ ‡ç­¾ï¼Ÿ", score: 5 },
                { id: 5, name: "é«˜å‹ç­èŒ", desc: "å‹åŠ›å®¹å™¨ï¼ˆç­èŒé”…ï¼‰æ˜¯å¦å®šæœŸæ ¡éªŒï¼Ÿæ˜¯å¦æœ‰è¿è¡Œè®°å½•ï¼Ÿæ˜¯å¦å¼ è´´ä½¿ç”¨æµç¨‹ã€åº”æ€¥å¤„ç½®ä¿¡æ¯", score: 5 },
                { id: 6, name: "èŒä¸šé˜²æŠ¤", desc: "å®éªŒäººå‘˜æ˜¯å¦ç©¿å®éªŒæœã€æˆ´æ‰‹å¥—ï¼Ÿå¿…è¦æ—¶æ˜¯å¦ä½©æˆ´å£ç½©/æŠ¤ç›®é•œï¼Ÿ", score: 5 },
                { id: 7, name: "é”å™¨ç®¡ç†", desc: "æ³¨å°„å™¨ã€åˆ€ç‰‡ç­‰é”å™¨æ˜¯å¦ç»Ÿä¸€æ”¾å…¥ä¸“ç”¨çš„é»„è‰²é”å™¨ç›’ä¸­ï¼Ÿ", score: 5 }
            ]},
            { cat: "åŒ–å­¦å“å®‰å…¨", items: [
                { id: 8, name: "åŒ–å­¦å“å‚¨å­˜", desc: "æ˜¯å¦åˆ†ç±»å­˜æ”¾ï¼ˆå¦‚é…¸ç¢±åˆ†ç¦»ã€æ˜“ç‡ƒå“å­˜æ”¾åœ¨é˜²çˆ†æŸœï¼‰ï¼Ÿ", score: 5 },
                { id: 9, name: "å±åŒ–å“ç®¡ç†", desc: "æ˜“åˆ¶æ¯’ã€æ˜“åˆ¶çˆ†åŒ–å­¦å“æ˜¯å¦å®è¡Œâ€œåŒäººåŒé”â€ç®¡ç†ï¼Ÿè®°å½•æœ¬æ˜¯å¦åˆ†åˆ«å­˜æ”¾ï¼Ÿ", score: 5 },
                { id: 10, name: "æ ‡ç­¾æ ‡è¯†", desc: "æ‰€æœ‰è¯•å‰‚ç“¶æ˜¯å¦æœ‰æ¸…æ™°ã€è€è…èš€çš„ä¸­æ–‡æ ‡ç­¾ï¼Ÿ", score: 5 },
                { id: 11, name: "MSDS", desc: "å®éªŒå®¤å†…æ˜¯å¦å¤‡æœ‰ä¸»è¦å±é™©åŒ–å­¦å“çš„å®‰å…¨æŠ€æœ¯è¯´æ˜ä¹¦ï¼ˆMSDSï¼‰ï¼Ÿ", score: 5 }
            ]},
            { cat: "æ¶ˆé˜²ä¸ç”µæ°”å®‰å…¨", items: [
                { id: 12, name: "é…’ç²¾ç¯", desc: "æ˜¯å¦å¤‡æ¡ˆï¼Ÿä½¿ç”¨å°å¸æ˜¯å¦åŠæ—¶å¡«å†™ï¼Ÿæ“ä½œåŒº1ç±³æ— æ˜“ç‡ƒç‰©ï¼Ÿé…ç­ç«å™¨åŠç­ç«æ¯¯ï¼Ÿ", score: 4 },
                { id: 13, name: "æ¶ˆé˜²å™¨æ", desc: "ç­èŒå™¨/æ¶ˆç«æ “æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ï¼Ÿå‘¨å›´æ˜¯å¦æ— é®æŒ¡ï¼Ÿ", score: 4 },
                { id: 14, name: "æ¶ˆé˜²é€šé“", desc: "ç–æ•£é€šé“ç•…é€šï¼Ÿæ˜¾è‘—ä½ç½®å¼ è´´ç´§æ€¥é€ƒç”Ÿç–æ•£è·¯çº¿å›¾ï¼Ÿ", score: 5 },
                { id: 15, name: "åº”æ€¥è®¾æ–½", desc: "æ´—çœ¼å™¨ã€ç´§æ€¥æ·‹æµ´è£…ç½®æ˜¯å¦å‡ºæ°´æ­£å¸¸ï¼Ÿæ°´è´¨æ˜¯å¦æ¸…æ´ï¼Ÿ", score: 5 },
                { id: 16, name: "ç”¨ç”µè§„èŒƒ", desc: "æ˜¯å¦å­˜åœ¨ç§æ¥ä¹±æ¥ç”µçº¿ç°è±¡ï¼Ÿæ˜¯å¦è¿è§„ä½¿ç”¨æ’æ’ï¼Ÿ", score: 3 },
                { id: 17, name: "å¤§åŠŸç‡è®¾å¤‡", desc: "ç¦»å¿ƒæœºã€çƒ¤ç®±ã€å†°ç®±ç­‰å¤§åŠŸç‡è®¾å¤‡å‘¨å›´æ˜¯å¦æœ‰æ˜“ç‡ƒç‰©ï¼Ÿ", score: 3 },
                { id: 18, name: "å……ç”µå™¨", desc: "æ˜¯å¦å­˜åœ¨äººä¸åœ¨æ—¶æ‰‹æœºå……ç”µå™¨ç•™åœ¨æ’åº§ä¸æ‹”çš„ç°è±¡ï¼Ÿ", score: 1 }
            ]},
            { cat: "å®éªŒå®¤åºŸç‰©å¤„ç†", items: [
                { id: 19, name: "åˆ†ç±»æ”¶é›†", desc: "åŒ–å­¦åºŸæ¶²æ˜¯å¦æŒ‰é…¸ã€ç¢±ã€æœ‰æœºç­‰åˆ†ç±»æ”¶é›†ï¼Ÿç¦æ­¢å€’å…¥ä¸‹æ°´é“ï¼Ÿ", score: 4 },
                { id: 20, name: "åŒ»ç–—åºŸç‰©", desc: "æ„ŸæŸ“æ€§åºŸå¼ƒç‰©æ˜¯å¦ä½¿ç”¨ä¸“ç”¨è“è‰²åƒåœ¾è¢‹ï¼Œå¹¶è¿›è¡Œå°å£ï¼Ÿ", score: 3 },
                { id: 21, name: "ä¸´æ—¶å­˜æ”¾", desc: "æš‚å­˜åŒºæ ‡è¯†æ˜ç¡®ï¼Ÿæœ‰é˜²æ¼æ‰˜ç›˜ï¼ŸåºŸæ¶²æ¡¶æ˜¯å¦ä¸è¶…è­¦ç¤ºçº¿ï¼Ÿ", score: 3 }
            ]},
            { cat: "æ°”ç“¶ä¸ç‰¹æ®Šè®¾å¤‡", items: [
                { id: 22, name: "æ°”ç“¶å›ºå®š", desc: "æ°”ç“¶æ˜¯å¦ç«‹ç¨³å¹¶æœ‰å›ºå®šé“¾/æ¶ï¼Œæœ‰ä¿æŠ¤å¸½ï¼Ÿæ˜¯å¦è¿œç¦»çƒ­æºï¼Ÿ", score: 4 },
                { id: 23, name: "çŠ¶æ€æ ‡è¯†", desc: "æ˜¯å¦æœ‰æ˜ç¡®æ°”ç“¶çŠ¶æ€æ ‡è¯†", score: 3 },
                { id: 24, name: "ä½æ¸©ä¿æŠ¤", desc: "æ¶²æ°®ç½å­˜æ”¾å¤„æ˜¯å¦é€šé£è‰¯å¥½ï¼Ÿæ“ä½œæ—¶æ˜¯å¦æœ‰é˜²å†»é˜²æŠ¤ï¼Ÿ", score: 3 }
            ]}
        ];

        let results = [];
        let db;

        // æ•°æ®åº“åˆå§‹åŒ–
        const request = indexedDB.open("TmuLabSafetyDB", 1);
        request.onupgradeneeded = e => { e.target.result.createObjectStore("records", { autoIncrement: true }); };
        request.onsuccess = e => { db = e.target.result; syncDraft(); updateStats(); };

        function renderList() {
            const container = document.getElementById('item-list');
            container.innerHTML = "";
            inspectionItems.forEach(cat => {
                const title = document.createElement('div'); title.className = 'cat-title'; title.innerText = cat.cat;
                container.appendChild(title);
                cat.items.forEach(item => {
                    const saved = results[item.id] || { status: 'y', pics: [], desc: "" };
                    results[item.id] = { ...item, ...saved };
                    const data = results[item.id];
                    const box = document.createElement('div'); box.className = 'item-box';
                    box.innerHTML = `
                        <div class="item-header"><span>${item.name}</span> <small style="color:red">æƒé‡${item.score}åˆ†</small></div>
                        <div class="item-desc">${item.desc}</div>
                        <div class="btn-group">
                            <div id="y-${item.id}" class="btn ${data.status==='y'?'active-y':''}" onclick="setStat(${item.id},'y')">åˆæ ¼</div>
                            <div id="n-${item.id}" class="btn ${data.status==='n'?'active-n':''}" onclick="setStat(${item.id},'n')">ä¸åˆæ ¼</div>
                        </div>
                        <div id="haz-${item.id}" class="hazard-area" style="display:${data.status==='n'?'block':'none'}">
                            <label class="camera-btn">ğŸ“· æ·»åŠ ç…§ç‰‡
                                <input type="file" accept="image/*" capture="environment" style="display:none" onchange="addPic(${item.id},this)">
                            </label>
                            <div id="grid-${item.id}" class="thumb-grid"></div>
                            <textarea id="text-${item.id}" placeholder="å¤‡æ³¨ä¿¡æ¯..." oninput="updateText(${item.id}, this.value)">${data.desc}</textarea>
                        </div>`;
                    container.appendChild(box);
                    renderPics(item.id);
                });
            });
        }

        function setStat(id, stat) {
            results[id].status = stat;
            document.getElementById(`y-${id}`).className = stat==='y'?'btn active-y':'btn';
            document.getElementById(`n-${id}`).className = stat==='n'?'btn active-n':'btn';
            document.getElementById(`haz-${id}`).style.display = stat==='n'?'block':'none';
            saveDraft();
        }
        function updateText(id, val) { results[id].desc = val; saveDraft(); }

        function addPic(id, input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const scale = Math.min(1, 800/img.width);
                    cvs.width = img.width * scale; cvs.height = img.height * scale;
                    cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                    results[id].pics.push(cvs.toDataURL('image/jpeg', 0.6));
                    renderPics(id); saveDraft();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function renderPics(id) {
            const grid = document.getElementById(`grid-${id}`);
            if(!grid) return; grid.innerHTML = "";
            results[id].pics.forEach((src, idx) => {
                const div = document.createElement('div'); div.className = 'thumb-wrap';
                div.innerHTML = `<img src="${src}" class="thumb-img"><button class="del-x" onclick="delPic(${id},${idx})">Ã—</button>`;
                grid.appendChild(div);
            });
        }

        function delPic(id, idx) { results[id].pics.splice(idx, 1); renderPics(id); saveDraft(); }

        function saveDraft() {
            localStorage.setItem("tmu_lab_draft", JSON.stringify({
                lab: document.getElementById('labName').value,
                ins: document.getElementById('inspector').value,
                data: results
            }));
        }

        function syncDraft() {
            const saved = JSON.parse(localStorage.getItem("tmu_lab_draft"));
            if(saved) {
                document.getElementById('labName').value = saved.lab || "";
                document.getElementById('inspector').value = saved.ins || "";
                results = saved.data || [];
            }
            renderList();
        }

        function saveToDB() {
            const lab = document.getElementById('labName').value;
            const ins = document.getElementById('inspector').value;
            if(!lab || !ins) return alert("è¯·å®Œæ•´å¡«å†™å®éªŒå®¤ä¿¡æ¯");
            const tx = db.transaction("records", "readwrite");
            tx.objectStore("records").add({ lab, ins, time: new Date().toLocaleString(), detail: JSON.parse(JSON.stringify(results)) });
            tx.oncomplete = () => { alert("è®°å½•å·²ä¿å­˜"); localStorage.removeItem("tmu_lab_draft"); location.reload(); };
        }

        function updateStats() {
            if(!db) return;
            db.transaction("records").objectStore("records").count().onsuccess = e => {
                document.getElementById('status').innerText = `æœ¬åœ°å·²å­˜: ${e.target.result} æ¡å®éªŒå®¤è®°å½•`;
            };
        }

        function resetAll() {
            if(confirm("å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼")) {
                localStorage.clear();
                if(db) db.close();
                indexedDB.deleteDatabase("TmuLabSafetyDB").onsuccess = () => location.reload();
            }
        }

        // --- Word å¯¼å‡º ---
        async function exportWord() {
            const tx = db.transaction("records", "readonly");
            tx.objectStore("records").getAll().onsuccess = async e => {
                const history = e.target.result;
                if(history.length === 0) return alert("æš‚æ— è®°å½•å¯å¯¼å‡º");
                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>å®éªŒå®¤æ£€æŸ¥æŠ¥å‘Š</title><style>body { font-family: 'SimSun', 'serif'; } .report-card { border: 2px solid #333; padding: 20px; margin-bottom: 30px; } .lab-tag { background: #333; color: #fff; padding: 10px; font-weight: bold; } .hazard-title { color: #ff3b30; font-weight: bold; margin-top: 15px; } .remark-box { background: #fff1f0; border-left: 4px solid #ff3b30; padding: 10px; margin: 10px 0; font-size: 13px; } img { width: 200px; height: auto; margin-right: 10px; margin-top: 10px; }</style></head><body><h1 style="text-align:center; color:#ff3b30;">å¤©æ´¥åŒ»ç§‘å¤§å­¦åŸºç¡€åŒ»å­¦é™¢å®éªŒå®¤å®‰å…¨æ£€æŸ¥æŠ¥å‘Š</h1>`;
                const footer = "</body></html>";
                let content = "";
                history.forEach(rec => {
                    const hazards = rec.detail.filter(d => d.status === 'n');
                    content += `<div class="report-card"><div class="lab-tag">å®éªŒå®¤åç§°ï¼š${rec.lab}</div><p>æ£€æŸ¥äººï¼š${rec.ins} | æ—¶é—´ï¼š${rec.time}</p>`;
                    if(hazards.length === 0) { content += `<p style="color:green; font-weight:bold;">âœ… å„é¡¹æ£€æŸ¥å‡åˆæ ¼</p>`; } 
                    else { hazards.forEach(h => { content += `<div style="border-top:1px solid #eee; margin-top:10px;"><div class="hazard-title">âŒ éšæ‚£é¡¹ç›®ï¼š${h.name}</div>${h.desc ? `<div class="remark-box"><strong>å¤‡æ³¨ï¼š</strong>${h.desc}</div>` : ''}<div>${h.pics.map(p => `<img src="${p}">`).join('')}</div></div>`; }); }
                    content += `</div>`;
                });
                const blob = new Blob([header + content + footer], { type: 'application/msword' });
                handleFileExport(blob, `åŸºç¡€åŒ»å­¦é™¢å®‰å…¨æ£€æŸ¥æŠ¥å‘Š_${new Date().getTime()}.doc`);
            };
        }

        function exportJSON() {
            const tx = db.transaction("records", "readonly");
            tx.objectStore("records").getAll().onsuccess = e => {
                const backup = { type: "TMU_LAB_BACKUP", draft: JSON.parse(localStorage.getItem("tmu_lab_draft")), records: e.target.result };
                handleFileExport(new Blob([JSON.stringify(backup)], {type: 'application/json'}), `æ•°æ®å¤‡ä»½_${new Date().toLocaleDateString()}.json`);
            };
        }

        async function handleFileExport(blob, fileName) {
            if (navigator.canShare && navigator.share) {
                try {
                    const file = new File([blob], fileName, {type: blob.type});
                    await navigator.share({ files: [file], title: 'æ£€æŸ¥æ•°æ®å¯¼å‡º' });
                    return;
                } catch (err) {}
            }
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName; link.click();
        }

        function triggerImport() { document.getElementById('importFile').click(); }
        function importBackup(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if(backup.type !== "TMU_LAB_BACKUP") throw "æ ¼å¼é”™è¯¯";
                    const tx = db.transaction("records", "readwrite");
                    tx.objectStore("records").clear().onsuccess = () => { backup.records.forEach(r => tx.objectStore("records").add(r)); };
                    tx.oncomplete = () => { alert("æ¢å¤æˆåŠŸï¼"); location.reload(); };
                } catch(err) { alert("å¯¼å…¥å¤±è´¥"); }
            };
            reader.readAsText(file);
        }

        function openPreview() {
            db.transaction("records").objectStore("records").getAll().onsuccess = e => {
                if(e.target.result.length === 0) return alert("æš‚æ— è®°å½•");
                let html = `<h2 style="color:#ff3b30; text-align:center;">å®éªŒå®¤éšæ‚£é¢„è§ˆ</h2>`;
                e.target.result.forEach(rec => {
                    const hazards = rec.detail.filter(d => d.status === 'n');
                    html += `<div class="report-card"><div class="lab-tag">å®éªŒå®¤ï¼š${rec.lab}</div><p style="font-size:12px; color:#666;">æ£€æŸ¥äººï¼š${rec.ins} | æ—¶é—´ï¼š${rec.time}</p>`;
                    if(hazards.length === 0) { html += `<p style="color:green; font-weight:bold;">âœ… åˆæ ¼</p>`; }
                    else { hazards.forEach(h => { html += `<div style="margin-top:10px;"><div style="font-weight:bold; color:red;">âŒ ${h.name}</div>${h.desc ? `<div class="hazard-text">${h.desc}</div>` : ''}<div>${h.pics.map(p => `<img src="${p}" style="width:100px; height:100px; object-fit:cover;">`).join('')}</div></div>`; }); }
                    html += `</div>`;
                });
                document.getElementById('preview-content').innerHTML = html;
                document.getElementById('check-ui').style.display = 'none';
                document.getElementById('preview-layer').style.display = 'block';
                window.scrollTo(0,0);
            };
        }
        function closePreview() { document.getElementById('preview-layer').style.display = 'none'; document.getElementById('check-ui').style.display = 'block'; }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šå¯¼å‡º CSV (åŸºäºæ‰£åˆ†è®¡ç®—å¾—åˆ†) ---
        async function shareCSV() {
            db.transaction("records").objectStore("records").getAll().onsuccess = async e => {
                const records = e.target.result; 
                if(records.length === 0) return alert("æš‚æ— è®°å½•");

                let csv = "\uFEFF"; // BOMå¤´é˜²ä¹±ç 

                records.forEach((rec) => {
                    // 1. è®¡ç®—è¯¥å®éªŒå®¤è®°å½•çš„æ€»å¾—åˆ† (100 - æ‰£åˆ†)
                    let scoreDeducted = 0;
                    rec.detail.forEach(d => {
                        // å¦‚æœçŠ¶æ€æ˜¯ä¸åˆæ ¼(n)ï¼Œç´¯åŠ å¯¹åº”çš„æƒé‡åˆ†(score)ä½œä¸ºæ‰£åˆ†
                        if (d.status === 'n') {
                            scoreDeducted += (d.score || 0);
                        }
                    });
                    const finalScore = 100 - scoreDeducted;

                    // 2. è¾“å‡ºæŠ¬å¤´ä¿¡æ¯
                    csv += `å®éªŒå®¤åç§°ï¼š,${rec.lab},,,æ£€æŸ¥äººï¼š,${rec.ins},æ€»å¾—åˆ†ï¼š,${finalScore}\n`;
                    csv += `æ£€æŸ¥æ—¥æœŸï¼š,${rec.time},,,,\n`;

                    // 3. è¾“å‡ºè¡¨å¤´
                    csv += "å¤§ç±»,é¡¹ç›®,æ£€æŸ¥è¦ç‚¹,ç»“è®º,å¤‡æ³¨,\n";

                    // 4. éå†æ£€æŸ¥é¡¹
                    let lastCat = ""; 
                    inspectionItems.forEach(category => {
                        category.items.forEach((item) => {
                            const savedData = rec.detail.find(d => d.id === item.id) || { status: 'y', desc: "" };
                            const catDisplay = (category.cat !== lastCat) ? category.cat : "";
                            lastCat = category.cat;

                            const projectName = item.name;
                            const checkPoint = item.desc; 
                            const result = (savedData.status === 'n' ? 'ä¸åˆæ ¼' : 'åˆæ ¼');
                            const remark = savedData.desc ? savedData.desc.replace(/\n/g, ' ').replace(/"/g, '""') : "";

                            csv += `"${catDisplay}","${projectName}","${checkPoint}","${result}","${remark}",\n`;
                        });
                    });

                    // ç•™ç©ºè¡ŒåŒºåˆ†å®éªŒå®¤
                    csv += "\n\n";
                });

                const fileName = `åŸºç¡€åŒ»å­¦é™¢å®‰å…¨æ£€æŸ¥æ±‡æ€»_${new Date().getTime()}.csv`;
                handleFileExport(new Blob([csv], {type:'text/csv;charset=utf-8'}), fileName);
            };
        }
    </script>
</body>
</html>